## OSPF State Machine: From Strangers to Neighbors

Two routers connect. They know nothing about each other yet. Before they can exchange a single route, they have to go through a deliberate handshake — a sequence of states that OSPF defines very precisely. This is the OSPF state machine.

It starts in the **Down** state. Down does not mean the interface is physically down. It simply means no hello packets have been heard from any neighbor yet. The router is listening, but the network is silent.

Then the first hello packet arrives. OSPF routers send hellos periodically on every enabled interface — the **Hello timer** controls how often (typically every 10 seconds on broadcast networks). Each hello packet carries the sender's router ID, its area ID, the hello and dead timers, and a list of all neighbors it has already heard from. When a router receives a hello packet from someone new, it transitions to the **Init** state. It has seen the neighbor, but the neighbor has not yet acknowledged it back. The relationship is one-sided.

The moment the neighbor sends a hello that includes this router's own router ID in its neighbor list, both sides have acknowledged each other. The session moves to the **2-Way** state. This is the first meaningful milestone. On point-to-point links, routers immediately proceed past this. On broadcast networks, they pause here — this is where the **DR and BDR election** happens. Any router that reaches 2-Way or higher is eligible to participate in the election. After the **Wait timer** expires (equal to the dead interval), the election concludes and the winners are set.

Once past 2-Way, the real work of building a synchronized database begins. The first step is **Exstart**, where the two routers negotiate who takes the lead. They exchange empty **Database Description (DBD)** packets to establish a master-slave relationship — the router with the higher router ID becomes the master and controls the sequence numbers. It is a small but important handshake before any real data flows.

In the **Exchange** state, both routers send each other their full Database Description packets — a summary of everything in their Link-State Database. Think of it as each router handing the other a table of contents, not the full book. Each entry lists an LSA type, the advertising router's ID, and a sequence number. The goal is to figure out what the other side has that you do not.

After comparing database summaries, each router knows exactly what it is missing. In the **Loading** state, it sends **Link State Request (LSR)** packets asking for the specific LSAs it needs. The neighbor responds with **Link State Update (LSU)** packets containing the full LSA content. This exchange continues until both routers have everything they asked for.

When the databases are fully synchronized, the session reaches **Full** state. Adjacency is complete. The router appears in each other's Router LSAs and, on broadcast networks, in the Network LSA generated by the DR. From this point, UPDATE packets flow only when something in the topology changes — not periodically, not in bulk. OSPF trusts that both sides have an identical view of the network.

One thing worth noting: not every neighbor relationship reaches Full. On broadcast networks, DROther routers stop at 2-Way with each other. They form full adjacency only with the DR and BDR. This is by design — it is the same adjacency control that keeps the n(n-1)/2 explosion in check.

The **Dead timer** watches over all of this continuously. If a router stops receiving hellos from a neighbor within the dead interval (typically 40 seconds on broadcast networks), it declares that neighbor down, tears down the adjacency, and triggers an LSA flood to notify the rest of the area. The network reconverges.

The state machine is the heartbeat of OSPF. Every neighbor relationship in the network is always in one of these states, and every transition is driven by a very specific event — a hello received, a timer expired, a database synchronized. Nothing is assumed. Everything is verified.

```text
                        +-----------+
              +-------->|   Down    |<--------------------------+
              |         +-----------+                           |
              |               |                                 |
              |        HelloReceived                            |
              |               |                                 |
              |               v                                 |
              |         +-----------+    1-WayReceived          |
              +---------|   Init    |-------------------------->+
              |         +-----------+                           |
              |               |                                 |
              |        2-WayReceived                            |
              |               |                                 |  KillNbr /
              |               v                                 |  InactivityTimer
              |         +-----------+    1-WayReceived          |
              +---------|   2-Way   |-------------------------->+
              |         +-----------+                           |
              |               |                                 |
              |            AdjOK?                               |
              |               |                                 |
              |               v                                 |
              |         +-----------+                           |
              +---------|  ExStart  |                           |
              |         +-----------+                           |
              |               |                                 |
              |        NegotiationDone                          |
              |               |                                 |
              |               v                                 |
              |         +-----------+  SeqNumberMismatch /      |
              +---------|  Exchange |-------------------------->+
              |         +-----------+                           |
              |               |                                 |
              |         ExchangeDone                            |
              |               |                                 |
              |               v                                 |
              |         +-----------+                           |
              +---------|  Loading  |                           |
              |         +-----------+                           |
              |               |                                 |
              |         LoadingDone                             |
              |               |                                 |
              |               v                                 |
              |         +-----------+                           |
              +---------|   Full    |---------------------------+
                        +-----------+
```
